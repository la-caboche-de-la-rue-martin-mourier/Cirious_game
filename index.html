<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Dis!puzzled</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="js/phaser.js"></script>
</head>
<body>
    <script>
        var game = new Phaser.Game(640, 384, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        function preload() {
            //game.load.tilemap('decors','assets/marcMap.json',null,Phaser.Tilemap.TILED_JSON);
            game.load.tilemap('coucou','assets/supertest.json',null,Phaser.Tilemap.TILED_JSON);
            //game.load.image('tileset','assets/MarcTileset1.png');
            game.load.image('tileset','assets/supermarket.png');
            game.load.image('barrel','assets/barel.png');
            game.load.image('banana','assets/Banana.png')
            game.load.image('bottle','assets/bottle.png');
            game.load.image('caddi1','assets/caddi1.png');
            game.load.image('caddi3','assets/caddi3.png')
            game.load.image('obs','assets/Obstacles.png');
            game.load.image('fullscreenbutton','assets/fullscreenbutton.png');
            game.load.spritesheet('guy','assets/guy.png',64,64);
            game.load.spritesheet('aveugle','assets/ondeblack.png',64,64);
            game.load.audio('theme','assets/sounds/projet_jeux_video.mp3');
        }
        var loaded = 0;
        var playerA;
        var playerB;
        var cursors;
        var keyQ;
        var keyD;
        var keyZ;
        var visualKey;
        var timer;

        var map;
        var ground;
        var obstacles;
        var shelf;
        var wall;
        var bottles;

        function gofull() {

            if (game.scale.isFullScreen)
            {
                game.scale.stopFullScreen();
            }
            else
            {
                game.scale.startFullScreen(false);
                
                create();
            }

        } 

        //
        function radar(){
            if(visualKey.isDown && timer >= 3){
                console.log(timer);
                playerB.animations.play('visu',10,false);
                timer = 0;
            }
        }

        function addBanana(player,banana){
            banana.kill();
            player.score -= 1;
            player.scoreText.text = 'Bananes Restantes : ' + player.score;
        }

        function checkMvt(playerA,playerB){
            //console.log(playerA.body.velocity);
            if(cursors.up.isDown == false && playerA.body.velocity.y<0){
                console.log('coucou');
                //playerA.body.velocity.y = 0;
            }
        }

        function updateTimer(){timer++;}      

        function keyUsed(player){
            if(player.body.velocity.x > 0){ return 'right'; }
            else if(player.body.velocity.x<0){ return 'left'; }
            else if(player.body.velocity.y > 0){ return 'down'; }
            else if(player.body.velocity.y < 0){ return 'up';}
            else{ return  'noInput'; }
        }

        function pushthat(player,bottle){
            if(actionKeyB.isDown){
                bottle.body.velocity.x = -150;
            }
            if(actionKey2B.isDown){
                bottle.body.velocity.x = 150;
            }
        }

        function pushthat2(player,upcaddi){
            if(actionKeyB.isDown){
                upcaddi.body.velocity.y = -150;
            }
            if(actionKey2B.isDown){
                upcaddi.body.velocity.y = 150;
            }
        }


        function stopping(bottle){
            bottle.body.velocity.x = 0 ; bottle.body.velocity.y = 0 ;
        }

        function create() {
            game.physics.startSystem(Phaser.Physics.ARCADE);

            //stretch to fill
            game.scale.fullScreenScaleMode = Phaser.ScaleManager.EXACT_FIT;

            //maintain aspect ratio
            game.scale.fullScreenScaleMode = Phaser.ScaleManager.SHOW_ALL;

            //map config
            map = game.add.tilemap('coucou');
            map.addTilesetImage('Supermarket','tileset');
            ground = map.createLayer('Ground');
            wall = map.createLayer('Wall');
            shelf = map.createLayer('Shelf');

            map.setCollisionByExclusion([0],true,wall);

            //HITBOXES
            obstacles = game.add.group();
            obstacles.enableBody = true;
            var obs = obstacles.create(115, 142, 'obs');
            obs.scale.x = 25; obs.scale.y = 50; obs.body.immovable = true;

            var obs = obstacles.create(210, 142, 'obs');
            obs.scale.x = 25; obs.scale.y = 50; obs.body.immovable = true;

            var obs = obstacles.create(115, 237, 'obs');
            obs.scale.x = 25; obs.scale.y = 50; obs.body.immovable = true;

            var obs = obstacles.create(210, 237, 'obs');
            obs.scale.x = 25; obs.scale.y = 50; obs.body.immovable = true;

            var obs = obstacles.create(355, 137, 'obs');
            obs.scale.x = 25; obs.scale.y = 20; obs.body.immovable = true;

            var obs = obstacles.create(355, 329, 'obs');
            obs.scale.x = 25; obs.scale.y = 20; obs.body.immovable = true;

            var obs = obstacles.create(355, 232, 'obs');
            obs.scale.x = 25; obs.scale.y = 20; obs.body.immovable = true;

            var obs = obstacles.create(484, 137, 'obs');
            obs.scale.x = 25; obs.scale.y = 20; obs.body.immovable = true;

            var obs = obstacles.create(484, 232, 'obs');
            obs.scale.x = 25; obs.scale.y = 20; obs.body.immovable = true;

            var obs = obstacles.create(484, 329, 'obs');
            obs.scale.x = 25; obs.scale.y = 20; obs.body.immovable = true;

            var obs = obstacles.create(2, 65, 'obs');
            obs.scale.x = 27; obs.scale.y = 190; obs.body.immovable = true;

            obstacles.alpha = 0;

            //objects creation
            bottles = game.add.group();
            bottles.enableBody = true;

            for (var i = 1; i < 6; i++){
                var bottle = bottles.create(i*68, 100, 'caddi1');
                bottle.scale.x = 1/*1.5*/; bottle.scale.y = 1/*1.5*/;
                bottle.body.collideWorldBounds = true;
                bottle.body.immovable = true;
                bottle.body.onWorldBounds = new Phaser.Signal();
                bottle.body.onWorldBounds.add(stopping);
            }

            upCaddys = game.add.group();
            upCaddys.enableBody = true;
            var upcaddi = upCaddys.create(170, 200, 'caddi3');
            upcaddi.scale.x = 1/*1.5*/; upcaddi.scale.y = 1/*1.5*/;
            upcaddi.body.collideWorldBounds = true; upcaddi.body.immovable = true;
            upcaddi.body.onWorldBounds = new Phaser.Signal(); upcaddi.body.onWorldBounds.add(stopping);


            bananas = game.add.group();
            bananas.enableBody = true;
            var banana = bananas.create(210, 200, 'banana');
            banana.scale.x= 0.12;
            banana.scale.y= 0.12;
            banana.body.gravity.x = 0;
            banana.body.gravity.y = 0;

            if(loaded == 0){
                music = /*new Phaser.Sound(game,'theme',1,true)*/  game.add.audio('theme');
                music.loop = true ;
                music.play();
                loaded ++;
            }
            // key biding

            keyQ = game.input.keyboard.addKey(Phaser.Keyboard.Q);
            keyD = game.input.keyboard.addKey(Phaser.Keyboard.D);
            keyZ = game.input.keyboard.addKey(Phaser.Keyboard.Z);
            keyS = game.input.keyboard.addKey(Phaser.Keyboard.S);
            actionKeyA = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_0);
            actionKeyB = game.input.keyboard.addKey(Phaser.Keyboard.A);
            actionKey2B = game.input.keyboard.addKey(Phaser.Keyboard.E);
            visualKey = game.input.keyboard.addKey(Phaser.Keyboard.X);


            //animation
            playerA = game.add.sprite(32, game.world.height - 150, 'guy');
            playerA.name = "playerA";
            game.physics.arcade.enable(playerA);
            playerA.body.collideWorldBounds = true;
            playerA.body.setSize(36, 25, 14, 32);
            playerA.scale.x = 0.7 ; playerA.scale.y = 0.7;
            playerA.animations.add('leftA',[8,9,10,11],10,true);
            playerA.animations.add('rightA',[4,5,6,7],10,true);
            playerA.animations.add('frontA',[0,1,2,3],10,true);
            playerA.animations.add('behindA',[12,13,14,15],10,true);
            
            playerB = game.add.sprite(62, game.world.height - 150, 'aveugle');
            playerB.name = "playerB";
            game.physics.arcade.enable(playerB);
            playerB.body.collideWorldBounds = true;
            playerB.body.setSize(32, 32, 16, 16);
            playerB.scale.x = 1 ; playerB.scale.y = 1;
            playerB.animations.add('visu',[0,1,2,3,4,5,6,7,8,9],10,false);

            //score display
            playerA.score = 1;
            playerA.scoreText = game.add.text(256, 16, 'Bananes Restantes : 1',{ fontsize: '32px', fill: '#000'});

            /*playerB.score = 0;
            playerB.scoreText = game.add.text(512, 16, 'scoreB: 0',{ fontsize: '32px', fill: '#000'});*/

            cursors = game.input.keyboard.createCursorKeys();

            fs_button = game.add.button(0,0,"fullscreenbutton",gofull,this);

            timer = 5;
            game.time.events.loop(Phaser.Timer.SECOND, updateTimer, this);

        }


        function update() {

            radar();

            //game.debug.body(playerB);

            //colliding 
            game.physics.arcade.collide([playerA,playerB],wall);
            game.physics.arcade.collide([playerA,playerB],obstacles);
            game.physics.arcade.collide(playerA,playerB);
            game.physics.arcade.collide(playerA,bottles);
            game.physics.arcade.collide(playerA,upCaddys);
            game.physics.arcade.collide(playerB,bottles,pushthat,null,this);
            game.physics.arcade.collide(playerB,upCaddys,pushthat2,null,this);
            game.physics.arcade.collide([bottles,upCaddys],[bottles,obstacles,upCaddys],stopping,null,this);
            game.physics.arcade.collide([bottles,upCaddys],wall,stopping,null,this);

            // movement definiton 

            if (cursors.left.isDown)
            {
                playerA.body.velocity.x = -120; playerA.body.velocity.y = 0;
                playerA.animations.play('leftA');
            }
            else if (cursors.right.isDown)
            {
                playerA.body.velocity.x = 120; playerA.body.velocity.y = 0;
                playerA.animations.play('rightA');
            }
            else if (cursors.down.isDown)
            {
                playerA.body.velocity.y = 120;
                playerA.body.velocity.x = 0;
                playerA.animations.play('frontA');  
            }
            else if(cursors.up.isDown){
                playerA.body.velocity.y = -120; playerA.body.velocity.x = 0;
                playerA.animations.play('behindA');
            }
            else
            {
                playerA.animations.stop();
                playerA.body.velocity.x = 0; playerA.body.velocity.y = 0;

            }

            if (keyQ.isDown)
            {
                playerB.body.velocity.x = -150; playerB.body.velocity.y = 0;
            }
            else if (keyD.isDown)
            {
                playerB.body.velocity.x = 150; playerB.body.velocity.y = 0;
            }
            else if (keyS.isDown)
            {
                playerB.body.velocity.y = 150; playerB.body.velocity.x = 0;
            }
            else if(keyZ.isDown){
                playerB.body.velocity.y = -150; playerB.body.velocity.x = 0;
            }
            else
            {
                playerB.body.velocity.x = 0; playerB.body.velocity.y = 0;
            }

            checkMvt(playerA,playerB);

            game.physics.arcade.overlap(playerA,bananas,addBanana,null,this);
        }


    </script>
    
</body>
</html>
</html>